"""
LLM Judge í”„ë¡¬í”„íŠ¸ (3ë‹¨ê³„)
Passëœ í…ìŠ¤íŠ¸ë“¤ì„ ë¹„êµí•˜ì—¬ ì„¸ë¶€ í’ˆì§ˆ ì ìˆ˜ ì‚°ì¶œ
"""

import json
import re
from typing import List, Dict, Any


def create_judge_prompt(
    strategy: str,
    pages: List[Dict],
    doc_meta: Dict[str, Any]
) -> str:
    """
    LLM Judge í”„ë¡¬í”„íŠ¸ ìƒì„± (ê°œì„  ë²„ì „)
    
    Args:
        strategy: ì „ëµ ì´ë¦„ (ì˜ˆ: 'pdfplumber+custom_split')
        pages: í˜ì´ì§€ ë°ì´í„° ë¦¬ìŠ¤íŠ¸
        doc_meta: ë¬¸ì„œ ë©”íƒ€ë°ì´í„°
        
    Returns:
        í”„ë¡¬í”„íŠ¸ ë¬¸ìì—´
    """
    
    # í…ìŠ¤íŠ¸ ìƒ˜í”Œ ì¶”ì¶œ (ìµœëŒ€ 1000ì)
    text_samples = []
    for page in pages[:1]:  # ëŒ€í‘œ 1í˜ì´ì§€ë§Œ
        text = page.get("text", "")[:1000]
        text_samples.append(f"[í˜ì´ì§€ {page.get('page', '?')}]\n{text}")
    
    sample_text = "\n\n".join(text_samples)
    
    # í‘œ ì •ë³´
    has_tables = any(page.get("tables", []) for page in pages)
    table_info = ""
    if has_tables:
        total_tables = sum(len(page.get("tables", [])) for page in pages)
        table_info = f"\ní‘œ í¬í•¨: ì´ {total_tables}ê°œ"
    
    prompt = f"""ë‹¹ì‹ ì€ PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ í’ˆì§ˆì„ **ì •ë°€ í‰ê°€**í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ğŸ“Œ **ì¤‘ìš”**: ì´ í…ìŠ¤íŠ¸ëŠ” ì´ë¯¸ **2ë‹¨ê³„ ê²€ì¦ì„ í†µê³¼**í–ˆìŠµë‹ˆë‹¤.
   â†’ ì‹¤ë¬´ ì‚¬ìš© ê°€ëŠ¥í•œ ìˆ˜ì¤€ìœ¼ë¡œ íŒì •ë¨
   â†’ ì§€ê¸ˆì€ ì—¬ëŸ¬ Pass ì „ëµ ì¤‘ **ìµœì„ ì„ ì„ íƒ**í•˜ê¸° ìœ„í•œ ì„¸ë¶€ í‰ê°€ì…ë‹ˆë‹¤.

---

## ğŸ“„ í‰ê°€ ëŒ€ìƒ

**ì „ëµ**: {strategy}
**ë¬¸ì„œ**: {doc_meta.get('document_name', 'unknown')}
**í˜ì´ì§€**: {len(pages)}ê°œ{table_info}

**ì¶”ì¶œëœ í…ìŠ¤íŠ¸**:
```
{sample_text}
```

---

## ğŸ¯ í‰ê°€ ê¸°ì¤€ (ê° 0~100ì )

### 1ï¸âƒ£ **S_read (ì½ê¸° ìˆœì„œ ì™„ì„±ë„)** [0-100ì ]
**í‰ê°€ ë‚´ìš©**:
- ë¬¸ë‹¨ê³¼ ë¬¸ì¥ì´ ë…¼ë¦¬ì  ìˆœì„œë¡œ ë°°ì—´ë˜ì—ˆëŠ”ê°€?
- ë‹¤ë‹¨(multi-column) ë ˆì´ì•„ì›ƒì´ ì •í™•íˆ ì²˜ë¦¬ë˜ì—ˆëŠ”ê°€?
- ëª©ë¡, ë²ˆí˜¸, ê³„ì¸µ êµ¬ì¡°ê°€ ì˜¬ë°”ë¥¸ê°€?

**ì ìˆ˜ ê¸°ì¤€**:
- 95-100: ì™„ë²½í•œ ì½ê¸° ìˆœì„œ, ë ˆì´ì•„ì›ƒ ì™„ë²½ ë³´ì¡´
- 85-94: ë§¤ìš° ìš°ìˆ˜, ì‚¬ì†Œí•œ ìˆœì„œ ì˜¤ë¥˜
- 70-84: ìš°ìˆ˜, ì¼ë¶€ ìˆœì„œ ì´ìŠˆ ìˆìœ¼ë‚˜ ì´í•´ ê°€ëŠ¥
- 60-69: ë³´í†µ, ìˆœì„œê°€ ë‹¤ì†Œ ë’¤ì„ì„

### 2ï¸âƒ£ **S_sent (ë¬¸ì¥ ì™„ê²°ì„±)** [0-100ì ]
**í‰ê°€ ë‚´ìš©**:
- ëª¨ë“  ë¬¸ì¥ì´ ì™„ì „í•œ í˜•íƒœë¡œ ì¶”ì¶œë˜ì—ˆëŠ”ê°€?
- ë‹¨ì–´ê°€ ì¤‘ê°„ì— ëŠê¸°ê±°ë‚˜ í•©ì³ì§€ì§€ ì•Šì•˜ëŠ”ê°€?
- ë„ì–´ì“°ê¸°ì™€ ì¤„ë°”ê¿ˆì´ ìì—°ìŠ¤ëŸ¬ìš´ê°€?

**ì ìˆ˜ ê¸°ì¤€**:
- 95-100: ì™„ë²½í•œ ë¬¸ì¥ êµ¬ì¡°, ì›ë¬¸ ê·¸ëŒ€ë¡œ
- 85-94: ë§¤ìš° ìš°ìˆ˜, ë¯¸ì„¸í•œ ë„ì–´ì“°ê¸° ì˜¤ë¥˜
- 70-84: ìš°ìˆ˜, ì¼ë¶€ ë‹¨ì–´ ë‹¨ì ˆ ìˆìœ¼ë‚˜ ì´í•´ ê°€ëŠ¥
- 60-69: ë³´í†µ, ë¬¸ì¥ ë‹¨ì ˆ ëˆˆì— ë”

### 3ï¸âƒ£ **S_noise (ë…¸ì´ì¦ˆ ì œê±° ìˆ˜ì¤€)** [0-100ì ]
**í‰ê°€ ë‚´ìš©**:
- í—¤ë”/í‘¸í„°ê°€ ê¹¨ë—ì´ ì œê±°ë˜ì—ˆëŠ”ê°€?
- í˜ì´ì§€ ë²ˆí˜¸ê°€ ë³¸ë¬¸ì— ì„ì´ì§€ ì•Šì•˜ëŠ”ê°€?
- ë¶ˆí•„ìš”í•œ ê¸°í˜¸ë‚˜ ë°˜ë³µ íŒ¨í„´ì´ ì—†ëŠ”ê°€?

**ì ìˆ˜ ê¸°ì¤€**:
- 95-100: ì™„ë²½í•œ í´ë¦°ì—…, ë…¸ì´ì¦ˆ 0%
- 85-94: ë§¤ìš° ê¹¨ë—, ì‚¬ì†Œí•œ ë…¸ì´ì¦ˆ
- 70-84: ê¹¨ë—, ì¼ë¶€ ë…¸ì´ì¦ˆ ìˆìœ¼ë‚˜ ë¬´ì‹œ ê°€ëŠ¥
- 60-69: ë³´í†µ, ë…¸ì´ì¦ˆê°€ ëˆˆì— ë„ì§€ë§Œ ì½ê¸° ë°©í•´ ì•ˆ í•¨

### 4ï¸âƒ£ **S_table (í‘œ ì¶”ì¶œ ì™„ì„±ë„)** [0-100ì ]
**í‰ê°€ ë‚´ìš©** (í‘œê°€ ìˆëŠ” ê²½ìš°):
- í–‰ê³¼ ì—´ì´ ì •í™•íˆ êµ¬ë¶„ë˜ì—ˆëŠ”ê°€?
- ì…€ ë‚´ìš©ì´ ì •í™•í•œ ìœ„ì¹˜ì— ë°°ì¹˜ë˜ì—ˆëŠ”ê°€?
- ë³‘í•© ì…€, í—¤ë”ê°€ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬ë˜ì—ˆëŠ”ê°€?

**í‘œê°€ ì—†ëŠ” ê²½ìš°**: 90ì  ë¶€ì—¬ (ì¤‘ë¦½)

**ì ìˆ˜ ê¸°ì¤€**:
- 95-100: í‘œ êµ¬ì¡° ì™„ë²½ ë³´ì¡´, ì…€ ì •ë ¬ ì •í™•
- 85-94: ë§¤ìš° ìš°ìˆ˜, ì‚¬ì†Œí•œ ì •ë ¬ ì˜¤ë¥˜
- 70-84: ìš°ìˆ˜, ì¼ë¶€ ì…€ ìœ„ì¹˜ ì˜¤ë¥˜ ìˆìœ¼ë‚˜ ì´í•´ ê°€ëŠ¥
- 60-69: ë³´í†µ, í‘œ êµ¬ì¡°ëŠ” ë³´ì¡´ë˜ë‚˜ ì •ë ¬ ì–´ê¸‹ë‚¨

### 5ï¸âƒ£ **S_fig (ë„í‘œ/ì´ë¯¸ì§€ ì„¤ëª… ì¶”ì¶œ)** [0-100ì ]
**í‰ê°€ ë‚´ìš©** (ê·¸ë¦¼/ë„í‘œê°€ ìˆëŠ” ê²½ìš°):
- ê·¸ë¦¼ ìº¡ì…˜ì´ ì¶”ì¶œë˜ì—ˆëŠ”ê°€?
- ì°¨íŠ¸/ê·¸ë˜í”„ì˜ ë ˆì´ë¸”ê³¼ ë²”ë¡€ê°€ ìˆëŠ”ê°€?
- ë‹¤ì´ì–´ê·¸ë¨ì˜ í…ìŠ¤íŠ¸ ìš”ì†Œê°€ í¬í•¨ë˜ì—ˆëŠ”ê°€?

**ê·¸ë¦¼ì´ ì—†ëŠ” ê²½ìš°**: 85ì  ë¶€ì—¬ (ì¤‘ë¦½)

**ì ìˆ˜ ê¸°ì¤€**:
- 95-100: ëª¨ë“  ì‹œê° ìë£Œ ì„¤ëª… ì™„ë²½ ì¶”ì¶œ
- 85-94: ìº¡ì…˜ê³¼ ì£¼ìš” ë ˆì´ë¸” ì¶”ì¶œë¨
- 70-84: ì¼ë¶€ ìº¡ì…˜ ëˆ„ë½, ì£¼ìš” ì •ë³´ëŠ” ìˆìŒ
- 60-69: ìº¡ì…˜ ë§ì´ ëˆ„ë½

---

## ğŸ“¤ ì‘ë‹µ í˜•ì‹

**JSONë§Œ** ì¶œë ¥í•˜ì„¸ìš” (ë‹¤ë¥¸ ì„¤ëª… ì—†ì´):

```json
{{
  "S_read": 88,
  "S_sent": 92,
  "S_noise": 85,
  "S_table": 90,
  "S_fig": 85,
  "rationale": "ì „ë°˜ì ìœ¼ë¡œ ë§¤ìš° ìš°ìˆ˜í•œ ì¶”ì¶œ í’ˆì§ˆ. ë‹¤ë‹¨ ë ˆì´ì•„ì›ƒì´ ì •í™•íˆ ì²˜ë¦¬ë˜ì—ˆê³  ë¬¸ì¥ ì™„ê²°ì„±ì´ ë›°ì–´ë‚¨. ì¼ë¶€ í—¤ë” ë…¸ì´ì¦ˆê°€ ë‚¨ì•„ìˆìœ¼ë‚˜ ì½ê¸°ì— ì§€ì¥ ì—†ìŒ. í‘œ êµ¬ì¡°ê°€ ì˜ ë³´ì¡´ë¨.",
  "comments": {{
    "read": "2ë‹¨ ë ˆì´ì•„ì›ƒì´ ì •í™•íˆ ì¢Œâ†’ìš° ìˆœì„œë¡œ ì²˜ë¦¬ë¨",
    "sent": "ë¬¸ì¥ ë‹¨ì ˆ ì—†ì´ ìì—°ìŠ¤ëŸ¬ìš´ íë¦„",
    "noise": "ìƒë‹¨ í—¤ë” ì¼ë¶€ ì”ì¡´í•˜ë‚˜ ë¬´ì‹œ ê°€ëŠ¥",
    "table": "3ê°œ í‘œ ëª¨ë‘ í–‰/ì—´ êµ¬ë¶„ ëª…í™•",
    "fig": "ê·¸ë¦¼ ìº¡ì…˜ 2ê°œ ëˆ„ë½, ë‚˜ë¨¸ì§€ëŠ” ì¶”ì¶œë¨"
  }}
}}
```

**í‰ê°€ ì›ì¹™**:
1. **Pass ë°›ì€ í…ìŠ¤íŠ¸**ì´ë¯€ë¡œ ê¸°ë³¸ 60ì  ì´ìƒ
2. **ë¹„êµ í‰ê°€**: ë‹¤ë¥¸ ì „ëµê³¼ ë¹„êµí•  ê²ƒì„ ì—¼ë‘
3. **ê°ê´€ì  í‰ê°€**: ì‹¤ì œ í’ˆì§ˆì— ê¸°ë°˜í•œ ì •í™•í•œ ì ìˆ˜
4. **ì„¸ë¶€ ê·¼ê±°**: rationaleê³¼ commentsì— êµ¬ì²´ì  ì´ìœ 

JSONë§Œ ì¶œë ¥:"""

    return prompt


def parse_judge_response(response_content: str) -> Dict[str, Any]:
    """
    LLM Judge ì‘ë‹µ íŒŒì‹±
    
    Args:
        response_content: LLM ì‘ë‹µ í…ìŠ¤íŠ¸
        
    Returns:
        {
            "S_read": float (0-100),
            "S_sent": float (0-100),
            "S_noise": float (0-100),
            "S_table": float (0-100),
            "S_fig": float (0-100),
            "rationale": str,
            "comments": dict
        }
    """
    
    # JSON ì¶”ì¶œ
    json_str = response_content.strip()
    
    # ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ë¡ ì œê±°
    if "```json" in json_str:
        json_match = re.search(r'```json\s*(.*?)\s*```', json_str, re.DOTALL)
        if json_match:
            json_str = json_match.group(1)
    elif "```" in json_str:
        json_match = re.search(r'```\s*(.*?)\s*```', json_str, re.DOTALL)
        if json_match:
            json_str = json_match.group(1)
    
    try:
        data = json.loads(json_str)
        
        # ì ìˆ˜ ì¶”ì¶œ ë° ê²€ì¦ (0-100 ë²”ìœ„)
        scores = {
            "S_read": max(0, min(100, float(data.get("S_read", 75)))),
            "S_sent": max(0, min(100, float(data.get("S_sent", 75)))),
            "S_noise": max(0, min(100, float(data.get("S_noise", 75)))),
            "S_table": max(0, min(100, float(data.get("S_table", 85)))),  # í‘œ ì—†ìœ¼ë©´ ë†’ê²Œ
            "S_fig": max(0, min(100, float(data.get("S_fig", 80)))),    # ê·¸ë¦¼ ì—†ìœ¼ë©´ ë†’ê²Œ
            "rationale": str(data.get("rationale", "í‰ê°€ ì™„ë£Œ")),
            "comments": data.get("comments", {})
        }
        
        return scores
        
    except (json.JSONDecodeError, ValueError, KeyError) as e:
        print(f"[ERROR] Judge ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {str(e)}")
        print(f"ì‘ë‹µ ë‚´ìš©: {response_content[:300]}...")
        
        # ê¸°ë³¸ê°’ ë°˜í™˜ (Pass ë°›ì•˜ìœ¼ë¯€ë¡œ 75ì  ê¸°ë³¸)
        return {
            "S_read": 75.0,
            "S_sent": 75.0,
            "S_noise": 75.0,
            "S_table": 85.0,
            "S_fig": 80.0,
            "rationale": "íŒŒì‹± ì‹¤íŒ¨ - ê¸°ë³¸ ì ìˆ˜ ë¶€ì—¬",
            "comments": {}
        }


if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸
    test_pages = [
        {
            "page": 1, 
            "text": "ì œ1ì¥ ì„œë¡ \n\në³¸ ë³´ê³ ì„œëŠ” 2024ë…„ ìƒë°˜ê¸° ì‹¤ì ì„ ë¶„ì„í•œ ë¬¸ì„œì…ë‹ˆë‹¤.\në§¤ì¶œì€ ì „ë…„ ëŒ€ë¹„ 15% ì¦ê°€í•˜ì˜€ìŠµë‹ˆë‹¤.",
            "tables": []
        }
    ]
    
    test_meta = {"document_name": "test_report.pdf"}
    
    prompt = create_judge_prompt("pdfplumber+custom_split", test_pages, test_meta)
    print("[OK] Judge í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ (ê°œì„  ë²„ì „)")
    print(f"ê¸¸ì´: {len(prompt)} chars")
    print("\n" + "="*60)
    print(prompt[:500] + "...")
    
    # ì‘ë‹µ íŒŒì‹± í…ŒìŠ¤íŠ¸
    test_response = """```json
{
  "S_read": 88,
  "S_sent": 92,
  "S_noise": 85,
  "S_table": 90,
  "S_fig": 85,
  "rationale": "ì „ë°˜ì ìœ¼ë¡œ ë§¤ìš° ìš°ìˆ˜",
  "comments": {
    "read": "ë ˆì´ì•„ì›ƒ ì™„ë²½",
    "sent": "ë¬¸ì¥ ìì—°ìŠ¤ëŸ¬ì›€"
  }
}
```"""
    
    parsed = parse_judge_response(test_response)
    avg_score = sum(parsed[k] for k in ['S_read', 'S_sent', 'S_noise', 'S_table', 'S_fig']) / 5
    print(f"\n[OK] ì‘ë‹µ íŒŒì‹± ì™„ë£Œ")
    print(f"í‰ê·  ì ìˆ˜: {avg_score:.2f}/100")
    print(f"ê°œë³„: read={parsed['S_read']}, sent={parsed['S_sent']}, noise={parsed['S_noise']}, table={parsed['S_table']}, fig={parsed['S_fig']}")
